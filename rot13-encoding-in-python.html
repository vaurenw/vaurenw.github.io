<!DOCTYPE html>
<html lang="en">
<head>
 <title>Frederik Braun: Tales of Python's Encoding</title>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />
 <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 200"><style>svg{background-color:%231f54a6;}text{fill:white;font-family:Georgia,Cambria,"Times New Roman",Times,serif;}</style><text y="1.2em" font-size="135">F</text></svg>'>
 <link href="https://vaurenw.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Frederik Braun ATOM Feed" />
 <link href="https://vaurenw.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Frederik Braun RSS Feed" />
 <meta property="og:site_name" content="Frederik Braun"/>
 <meta property="og:type" content="website"/>
 <meta name="twitter:card" content="summary"/>
 <meta name="description" content="Tales of Python's Encoding" />
 <meta property="og:title" content="Tales of Python's Encoding"/>
 <meta property="og:url" content="https://vaurenw.github.io/rot13-encoding-in-python.html"/>
 <meta name="twitter:title" content="Tales of Python's Encoding" />
 <meta name="fediverse:author" content="@freddy@security.plumbing" />
 <link rel="canonical" href="https://vaurenw.github.io/rot13-encoding-in-python.html"/>
</head>

<body>
<header class="site-header" role="banner">
<div class="wrapper"><a class="site-title" rel="author" href="/">Frederik Braun</a><nav class="site-nav">
  <input type="checkbox" id="nav-trigger" class="nav-trigger">
  <label for="nav-trigger">
  <span class="menu-icon">
    <svg viewBox="0 0 18 15" width="18px" height="15px">
      <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
    </svg>
  </span>
  </label>
  <div class="trigger">
    <a class="page-link" href="https://vaurenw.github.io/archives.html">Blog</a>
    <a class="page-link" href="https://vaurenw.github.io/pages/publications.html">Portfolio</a>
    <a class="page-link" href="https://vaurenw.github.io/contact.html">Contact</a>
</div>
</nav></div>
</header>

<hr class="tophr">
<div id='wrapper' class="wrapper">
<div id='text1'>
        
<header>
  <h1>Tales of Python's Encoding</h1>
  <time datetime="2014-03-17T00:00:00+01:00">Mon 17 March 2014</time>
</header>
<article>
    <p><em>This article was also published in the third issue of the <a href="https://startpage.com/do/search?query=%22International%20Journal%20of%20PoC%20||%20GTFO%22">International Journal of PoC || GTFO</a>. This is my submission after editorial "grooming" and "[dressing] in the best Sunday clothes of proper church English" :-)</em>.</p>
<p>Many beginners of Python have suffered at the hand of the almighty SyntaxError. One of the less
frequently seen, yet still not uncommon instances is something like the following, which appears when
Unicode or other non-ASCII characters are used in a Python script.</p>
<pre>
SyntaxError: Non-ASCII character ... in ..., but no encoding declared;
see http://www.python.org/peps/pep-0263.html for details
</pre>

<p>The common solution to this error is to place this magic comment as the first or second line of your
Python script. This tells the interpreter that the script is written in UTF8, so that it can properly parse the
file.</p>
<div class="highlight"><pre><span></span><code># encoding: utf-8
</code></pre></div>

<p>I have stumbled upon the following hack many times, but I have yet to see a complete write-up in our
circles. It saddens me that I can’t correctly attribute this trick to a specific neighbor, as I have forgotten
who originally introduced me to this hackery. But hackery it is.</p>
<h3>The background</h3>
<p>Each October, the neighborly <a href="https://fluxfingers.net">FluxFingers</a> team hosts <a href="hack.lu">hack.lu</a>’s CTF competition in Luxembourg. Just last
year, I created a tiny challenge for this CTF that consists of a single file called “packed” which was supposed
to contain some juicy data. As with every decent CTF task, it has been written up on a few blogs. To my
distress, none of those summaries contains the full solution.
The challenge was in identifying the hidden content of the file, of which there were three. Using the liberal
interpretation of the PDF format<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>, one could place a document at the end of a Python script, enclosed in
multi-line string quotes<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>.
The Python script itself was surrounded by weird unprintable characters that make rendering in command
line tools like <code>less</code> or <code>cat</code> rather unenjoyable. What most people identified was an encoding hint.</p>
<pre>
00000a0: 0c0c 0c0c 0c0c 0c0c 2364 6973 6162 6c65  ........#disable
00000b0: 642d 656e 636f 6469 6e67 3a09 5f72 6f74  d-encoding:._rot
...
0000180: 5f5f 5f5f 5f5f 5f5f 5f5f 5f5f 5f5f 5f5f  ________________
0000190: 3133 037c 1716 0803 2010 1403 1e1b 1511  13.|.... .......
</pre>

<p>Despite the unprintables, the long range of underscores didn’t really fend off any serious adventurer. The
following content therefore had to be rot13 decoded. The rest of the challenge made up a typical crackme.
Hoping that the reader is entertained by a puzzle like this, the remaining parts of that crackme will be left
as an exercise.
The real trick was sadly never discovered by any participant of the CTF. The file itself was not a PDF that
contained a Python script, but a python script that contained a PDF. The whole file is actually executable
with your python interpreter!
Due to this hideous encoding hint, which is better known as a magic comment,<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup> the python interpreter
will fetch the codec’s name using a quite liberal regex to accept typical editor settings, such as “vim: set
fileencoding=foo” or “-*- coding: foo”. With this codec name, the interpreter will now import a python file
with the matching name<sup id="fnref:4"><a class="footnote-ref" href="#fn:4">4</a></sup> and use it to modify the existing code on the fly.</p>
<h3>The PoC</h3>
<p>Recognizing that the <code>cevag</code> is the Rot13 encoding of Python’s print command, it’s easy to test this strange
behavior.</p>
<div class="highlight"><pre><span></span><code><span class="c">% cat poc.py</span>
#!<span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python</span>
#<span class="n">encoding</span><span class="p">:</span><span class="w"> </span><span class="n">rot13</span>
<span class="n">cevag</span><span class="w"> </span><span class="s">’Hello</span><span class="w"> </span><span class="s">World’</span>
<span class="c">% ./poc.py</span>
<span class="n">Hello</span><span class="w"> </span><span class="s">World</span>
<span class="c">%</span>
</code></pre></div>

<h3>Caveats</h3>
<p>Sadly, this only works in Python versions 2.X, starting with 2.5. My current test with Python 3.3 yields first
an unknown encoding error (the “rot13” alias has sadly been removed, so that only “rot-13” and “rot_13”
could work). But Python 3 also distinguishes <code>strings</code> from <code>bytearrays</code>, which leads to type errors when
trying this PoC in general. Perhaps <code>rot_13.py</code> in the python distribution itself might be broken?
There are numerous other formats to be found in the encodings directory, such as ZIP, BZip2 and Base64,
but I’ve been unable to make them work. Most lead to padding and similar errors, but perhaps a clever
reader can make them work.
And with this, I close the chapter of Python encoding stories:</p>
<div class="highlight"><pre><span></span><code>TGSB
</code></pre></div>

<div class="footnote">
<hr>
<ol>
<li id="fn:1">
<p>As
seems to be mentioned in every PoC||GTFO issue, the header doesn’t need to appear exactly at the file’s beginning, but
within the first 1,024 bytes.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p><code>"""This is a multiline Python string.
It has three quotes."""</code>&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>See <a href="http://www.python.org/dev/peps/pep-0263/">Python PEP 0263, Defining Python Source Code Encodings</a>&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>See /usr/lib/python2.7/encoding/__init__.py near line 99&#160;<a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
</ol>
</div>
</article>

<hr>

<section id="minicontact">
<em>
<!-- Please comment on <a href="https://social.security.plumbing/@freddy">Mastodon</a>. -->
If you find a mistake in this article, you can <a href="https://github.com/freddyb/homepage/edit/main/content/python-encoding.md">submit a pull request on GitHub</a>.
</em>
</section>

<section id="article-list">
<h4>Recent posts</h4>
<ol>
  <li><a href="https://vaurenw.github.io/madweb-keynote-2025.html">With Carrots & Sticks - Can the browser handle web security?</a>
    <em>(Tue 08 April 2025)</em>
  </li>
  <li><a href="https://vaurenw.github.io/home-assistant-can-not-be-secured-for-internet-access.html">Home assistant can not be secured for internet access</a>
    <em>(Sun 15 December 2024)</em>
  </li>
  <li><a href="https://vaurenw.github.io/modern-solutions-xsleaks.html">Modern solutions against cross-site attacks</a>
    <em>(Tue 26 November 2024)</em>
  </li>
  <li><a href="https://vaurenw.github.io/prompt-injections-and-a-demo.html">Prompt Injections and a demo</a>
    <em>(Wed 18 September 2024)</em>
  </li>
  <li><a href="https://vaurenw.github.io/mozilla-monument.html">The Mozilla Monument in San Francisco</a>
    <em>(Fri 05 July 2024)</em>
  </li>
            
</ol>
</section>
</div>
</div>
</body>
</html>