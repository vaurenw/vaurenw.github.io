<!DOCTYPE html>
<html lang="en">
<head>
 <title>Frederik Braun: How Firefox gives special permissions to some domains</title>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />
 <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 200"><style>svg{background-color:%231f54a6;}text{fill:white;font-family:Georgia,Cambria,"Times New Roman",Times,serif;}</style><text y="1.2em" font-size="135">F</text></svg>'>
 <link href="https://vaurenw.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Frederik Braun ATOM Feed" />
 <link href="https://vaurenw.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Frederik Braun RSS Feed" />
 <meta property="og:site_name" content="Frederik Braun"/>
 <meta property="og:type" content="website"/>
 <meta name="twitter:card" content="summary"/>
 <meta name="description" content="How Firefox gives special permissions to some domains" />
 <meta property="og:title" content="How Firefox gives special permissions to some domains"/>
 <meta property="og:url" content="https://vaurenw.github.io/special-browser-privileges-for-some-domains.html"/>
 <meta name="twitter:title" content="How Firefox gives special permissions to some domains" />
 <meta name="fediverse:author" content="@freddy@security.plumbing" />
 <link rel="canonical" href="https://vaurenw.github.io/special-browser-privileges-for-some-domains.html"/>
</head>

<body>
<header class="site-header" role="banner">
<div class="wrapper"><a class="site-title" rel="author" href="/">Frederik Braun</a><nav class="site-nav">
  <input type="checkbox" id="nav-trigger" class="nav-trigger">
  <label for="nav-trigger">
  <span class="menu-icon">
    <svg viewBox="0 0 18 15" width="18px" height="15px">
      <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
    </svg>
  </span>
  </label>
  <div class="trigger">
    <a class="page-link" href="https://vaurenw.github.io/archives.html">Blog</a>
    <a class="page-link" href="https://vaurenw.github.io/pages/publications.html">Portfolio</a>
    <a class="page-link" href="https://vaurenw.github.io/contact.html">Contact</a>
</div>
</nav></div>
</header>

<hr class="tophr">
<div id='wrapper' class="wrapper">
<div id='text1'>
        
<header>
  <h1>How Firefox gives special permissions to some domains</h1>
  <time datetime="2024-02-02T00:00:00+01:00">Fri 02 February 2024</time>
</header>
<article>
    <p>Today, I found someone tweeting about a neat <a href="https://crbug.com/1472898">security bug in Chrome, that
bypasses how Chrome disallows extensions from injecting JavaScript into
special domains like <code>chrome.google.com</code></a>.
The intention of this block is that browsers give special permissions to
some internal pages that allow troubleshooting, resetting the browser,
installing extensions and more.</p>
<p>The bug in question was an easy bypass of a domain block list due to a DNS
trick. Due to a strict host name match, an attacker could extend the current
hostname with a trailing dot to <code>chrome.google.com.</code> and bypass the block.</p>
<p>I believe, this allowed all extensions that can inject content scripts into
arbitrary domains to potentially make use of these extra privileges.</p>
<p>Of course, this got me thinking. What if we have this bug in Firefox too?
So I went on and looked at our code. Fortunately, I have been playing with
our permission system for quite a while already, so I knew what to do.</p>
<p>First of all, Firefox uses a so-called PermissionManager API, which gets
its default values from the file
<a href="https://searchfox.org/mozilla-central/rev/14dc8f0e748d44778a02ffcf9ebcda3851b2bf9e/browser/app/permissions">browser/app/permissions</a>
in the source tree. At the time of writing this article, the four different
possible permissions are <code>uitour</code>, <code>install</code>, <code>remote-troubleshooting</code> and
 <code>autoplay-media</code>. So far, I have only looked into the first two, as I know
 how they work and what they do. But for the purpose of this analysis, and
 due to all of them going throgh the
 <a href="https://searchfox.org/mozilla-central/source/netwerk/base/nsIPermissionManager.idl#47">PermissionManager</a>,
 I am relatively confident that testing two of those should verify the
 behavior of the API in itself - regardless of the specific permissions and
 sites involved.</p>
<p>The <code>install</code> permission is used on <code>addons.mozilla.org</code> to allow the website
to trigger the installation of Firefox extensions. In fact, you can test that
this is the case by navigating to <code>addons.mozilla.org</code> and looking at the
exposed interfaces: <code>typeof AddonManager</code> returns <code>"function"</code>.
However, on any other web page, the result of that expression is <code>undefined</code>.</p>
<p>Now that we know how to test whether a page has the <code>install</code> permission, we
can open tab that goes to <code>addons.mozilla.org.</code> and do the same again.
What's <code>typeof AddonManager</code> here? <code>undefined</code>. No dice.</p>
<p>Let's continue with the <code>uitour</code> permission.
The <code>uitour</code> permission is used in Firefox's new tab, support and download
pages. It is used to invoke functionality from the user interface.
When a Firefox user is being presented new features after a major upgrade,
the <code>uitour</code> events can highlight Firefox menu buttons or open popups that
contain new funcionality.</p>
<p>A specific example that I remember is that for example, when a Firefox user
tries to download a new Firefox package, we assume that they are confused or
dissatisfied with how their browser is setup right now. So instead of
offering a download file, we also suggest "refreshing" Firefox, which can
help undo some undesired customizations without losing stored passwords
and such.</p>
<p>The code that you can run to try the <code>uitour</code> feature on <code>www.mozilla.org</code>
is as such:</p>
<div class="highlight"><pre><span></span><code><span class="nb">document</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">CustomEvent</span><span class="p">(</span><span class="s1">&#39;mozUITour&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">bubbles</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">detail</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;resetFirefox&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}));</span>
</code></pre></div>

<p>Dispatching this event will get you a new impressive modal dialog that asks
the user if they really want to refresh Firefox.</p>
<p>Now that we have a test for the <code>uitour</code> feature, we can do the same thing
we tried last time: Add a trailing dot and try again.</p>
<p>Going to <code>www.mozilla.org.</code> and trying again yields similar results as above:
No prompt shows.</p>
<p>To summarize: Our quick analysis has shown that even if we could get the web
extension code to be confused about whether a page should be scripted. The
 permission manager does not play along.</p>
<p>I think we can safely assume that Firefox is not affected by the same bug.
But you shouldn't take my word for it. Feel free to prove me wrong:
Here are some links to our code:</p>
<ul>
<li><a href="https://searchfox.org/mozilla-central/source/toolkit/mozapps/extensions/AddonManagerWebAPI.cpp#84">AddonManager API code</a></li>
<li><a href="https://searchfox.org/mozilla-central/source/dom/webidl/AddonManager.webidl#60">AddonManager Interface</a></li>
<li><a href="https://searchfox.org/mozilla-central/search?q=_sendEvent&amp;path=uitour&amp;case=false&amp;regexp=false">Code search for additional uitour event examples</a></li>
</ul>
<p>If you feel like you have found something that I did not, please submit to the
<a href="https://www.mozilla.org/en-US/security/client-bug-bounty/">Firefox bug bounty program</a>.</p>
</article>

<hr>

<section id="minicontact">
<em>
<!-- Please comment on <a href="https://social.security.plumbing/@freddy">Mastodon</a>. -->
If you find a mistake in this article, you can <a href="https://github.com/freddyb/homepage/edit/main/content/special-browser-privileges-for-some-domains.md">submit a pull request on GitHub</a>.
</em>
</section>

<section id="article-list">
<h4>Recent posts</h4>
<ol>
  <li><a href="https://vaurenw.github.io/madweb-keynote-2025.html">With Carrots & Sticks - Can the browser handle web security?</a>
    <em>(Tue 08 April 2025)</em>
  </li>
  <li><a href="https://vaurenw.github.io/home-assistant-can-not-be-secured-for-internet-access.html">Home assistant can not be secured for internet access</a>
    <em>(Sun 15 December 2024)</em>
  </li>
  <li><a href="https://vaurenw.github.io/modern-solutions-xsleaks.html">Modern solutions against cross-site attacks</a>
    <em>(Tue 26 November 2024)</em>
  </li>
  <li><a href="https://vaurenw.github.io/prompt-injections-and-a-demo.html">Prompt Injections and a demo</a>
    <em>(Wed 18 September 2024)</em>
  </li>
  <li><a href="https://vaurenw.github.io/mozilla-monument.html">The Mozilla Monument in San Francisco</a>
    <em>(Fri 05 July 2024)</em>
  </li>
            
</ol>
</section>
</div>
</div>
</body>
</html>