<!DOCTYPE html>
<html lang="en">
<head>
 <title>Frederik Braun: Security Review: HTML sanitizer in Thunderbird</title>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />
 <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 200"><style>svg{background-color:%231f54a6;}text{fill:white;font-family:Georgia,Cambria,"Times New Roman",Times,serif;}</style><text y="1.2em" font-size="135">F</text></svg>'>
 <link href="https://vaurenw.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Frederik Braun ATOM Feed" />
 <link href="https://vaurenw.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Frederik Braun RSS Feed" />
 <meta property="og:site_name" content="Frederik Braun"/>
 <meta property="og:type" content="website"/>
 <meta name="twitter:card" content="summary"/>
 <meta name="description" content="Security Review: HTML sanitizer in Thunderbird" />
 <meta property="og:title" content="Security Review: HTML sanitizer in Thunderbird"/>
 <meta property="og:url" content="https://vaurenw.github.io/secreview-750436.html"/>
 <meta name="twitter:title" content="Security Review: HTML sanitizer in Thunderbird" />
 <meta name="fediverse:author" content="@freddy@security.plumbing" />
 <link rel="canonical" href="https://vaurenw.github.io/secreview-750436.html"/>
</head>

<body>
<header class="site-header" role="banner">
<div class="wrapper"><a class="site-title" rel="author" href="/">Frederik Braun</a><nav class="site-nav">
  <input type="checkbox" id="nav-trigger" class="nav-trigger">
  <label for="nav-trigger">
  <span class="menu-icon">
    <svg viewBox="0 0 18 15" width="18px" height="15px">
      <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
    </svg>
  </span>
  </label>
  <div class="trigger">
    <a class="page-link" href="https://vaurenw.github.io/archives.html">Blog</a>
    <a class="page-link" href="https://vaurenw.github.io/pages/publications.html">Portfolio</a>
    <a class="page-link" href="https://vaurenw.github.io/contact.html">Contact</a>
</div>
</nav></div>
</header>

<hr class="tophr">
<div id='wrapper' class="wrapper">
<div id='text1'>
        
<header>
  <h1>Security Review: HTML sanitizer in Thunderbird</h1>
  <time datetime="2013-07-22T00:00:00+02:00">Mon 22 July 2013</time>
</header>
<article>
    <p>I spent a few days working on a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=750436">security review for
Thunderbird's HTML sanitizer</a>.
Thunderbird has three presets for viewing mail: Original HTML, Simple
HTML, and Plain Text. No matter which preset the user prefers, emails
should not execute JavaScript. And this is where the HTML sanitizer
joins our party.</p>
<p>This security review was discussed in one of my first weeks at Mozilla
and though being <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=704482">a very interesting topic</a>, it soon occured to me that
I might have bitten off more than I could chew. So the security review got
stuck in my queue and I finally dared to take a stab at it months later.
(Thanks to those fellow Mozillians who helped me getting started!)</p>
<h4>The key lesson about HTML sanitizers is: Don't even consider writing your own.</h4>
<p>So without further ado, I started collecting bits and pieces together.
First I required <a href="https://developer.mozilla.org/en-US/docs/Simple_Thunderbird_build">creating a recent build of Thunderbird</a>. Then I looked into <a href="https://developer.mozilla.org/en/docs/Writing_xpcshell-based_unit_tests">XPCShell tests</a>
(unit tests using Mozilla's privileged JavaScript libraries) and the <a href="https://developer.mozilla.org/en-US/docs/XPCOM_Interface_Reference/nsIParserUtils#sanitize">nsIParserUtils interface</a>.
My next step was writing a basic sanitizer call, and it turned out comparably
easy:</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">ParserUtils</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nx">Cc</span><span class="p">[</span><span class="s2">&quot;@mozilla.org/parserutils;1&quot;</span><span class="p">].</span><span class="nx">getService</span><span class="p">(</span><span class="nx">Ci</span><span class="p">.</span><span class="nx">nsIParserUtils</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">sanitizeFlags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ParserUtils</span><span class="p">.</span><span class="nx">SanitizerCidEmbedsOnly</span><span class="o">|</span><span class="nx">ParserUtils</span><span class="p">.</span><span class="nx">SanitizerDropForms</span><span class="o">|</span><span class="nx">ParserUtils</span><span class="p">.</span><span class="nx">SanitizerDropNonCSSPresentation</span><span class="p">;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ParserUtils</span><span class="p">.</span><span class="nx">sanitize</span><span class="p">(</span><span class="s2">&quot;XXX HTML here&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">sanitizeFlags</span><span class="p">);</span>
</code></pre></div>

<p>With this prototype, I could easily loop around a dataset of HTML vectors.
For this I chose the vectors from the <a href="http://html5sec.org">html5 security cheat sheet</a>
and <a href="http://ha.ckers.org/xss.html">RSnake's old XSS cheat sheet</a>
(thank you guys!)</p>
<p>Thankfully the html5 security cheat sheet has its attacks in a
<a href="http://html5security.googlecode.com/svn/trunk/items.json">JSON file</a>.
Extracting them was as easy as taking this dataset and joining the vectors
with the file that contains the actual attack <a href="http://html5security.googlecode.com/svn/trunk/payload.json">payload</a>,
(i.e., JavaScript alerts and other triggers in various encodings). The
XPCShell comes with a <code>load()</code> function which makes it very easy to include these JSON files.</p>
<p>The full test then looks a bit like this:</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">Ci</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Components</span><span class="p">.</span><span class="nx">interfaces</span><span class="p">;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">Cc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Components</span><span class="p">.</span><span class="nx">classes</span><span class="p">;</span>

<span class="c1">// gives us an items object:</span>
<span class="nx">load</span><span class="p">(</span><span class="s2">&quot;html5sec_items.js&quot;</span><span class="p">);</span>
<span class="c1">// possible payloads for within those vectors (items[x].data)</span>
<span class="nx">load</span><span class="p">(</span><span class="s2">&quot;html5sec_payloads.js&quot;</span><span class="p">);</span>

<span class="c1">// from html5sec.org&#39;s import.js:</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="c1">// replace the payload templates</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">payload</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">payloads</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">regex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">payload</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gm&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">items</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">items</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">regex</span><span class="p">,</span><span class="w"> </span><span class="nx">payloads</span><span class="p">[</span><span class="nx">payload</span><span class="p">]);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">attachment</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">items</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">attachment</span><span class="p">.</span><span class="nx">raw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">items</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">attachment</span><span class="p">.</span><span class="nx">raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">items</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">attachment</span><span class="p">.</span><span class="nx">raw</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">regex</span><span class="p">,</span><span class="w"> </span><span class="nx">payloads</span><span class="p">[</span><span class="nx">payload</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="c1">// initialize parser object</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">ParserUtils</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nx">Cc</span><span class="p">[</span><span class="s2">&quot;@mozilla.org/parserutils;1&quot;</span><span class="p">].</span><span class="nx">getService</span><span class="p">(</span><span class="nx">Ci</span><span class="p">.</span><span class="nx">nsIParserUtils</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">sanitizeFlags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ParserUtils</span><span class="p">.</span><span class="nx">SanitizerCidEmbedsOnly</span><span class="o">|</span><span class="nx">ParserUtils</span><span class="p">.</span><span class="nx">SanitizerDropForms</span><span class="o">|</span><span class="nx">ParserUtils</span><span class="p">.</span><span class="nx">SanitizerDropNonCSSPresentation</span><span class="p">;</span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// sanitize vector</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ParserUtils</span><span class="p">.</span><span class="nx">sanitize</span><span class="p">(</span><span class="nx">items</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">sanitizeFlags</span><span class="p">);</span>
<span class="w">  </span><span class="nx">items</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">sanitized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// results for html5sec cheat sheet</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">mini_items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">items</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="nx">data</span><span class="o">:</span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">sanitized</span><span class="o">:</span><span class="nx">e</span><span class="p">.</span><span class="nx">sanitized</span><span class="p">};</span><span class="w"> </span><span class="p">});</span>

<span class="nx">load</span><span class="p">(</span><span class="s2">&quot;xss_rsnake.js&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// array of rsnake xss cheat sheet entries</span>
<span class="nx">rsnake_results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">xss_rsnake</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ParserUtils</span><span class="p">.</span><span class="nx">sanitize</span><span class="p">(</span><span class="nx">xss_rsnake</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="w"> </span><span class="nx">sanitizeFlags</span><span class="p">);</span>
<span class="w">  </span><span class="nx">rsnake_results</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">xss_rsnake</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="w"> </span><span class="s2">&quot;sanitized&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">out</span><span class="p">});</span>
<span class="p">}</span>
<span class="nx">collected_results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mini_items</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">rsnake_results</span><span class="p">);</span>
<span class="nx">dump</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">collected_results</span><span class="p">));</span><span class="w"> </span><span class="c1">// full output as JSON</span>

<span class="c1">// html-strings to stdout:</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">collected_results</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">dump</span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">sanitized</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>After sanitizing all of these attack vectors, I had to review the
results. Since this is my first dive into XPCShell tests, I didn't dare
to hook all the logic behind script parsing, image loading, event
handler registration and so forth. Instead I reviewed the sanitized
output by hand (a <a href="http://jsoneditoronline.org/">JSON capable editor</a>
helps a lot). After that I also put the combined output into a single HTML
file and opened it in the browser. The Firefox Developer Console
helped me confirm that no resources were loaded and no scripts executed.</p>
<p>This means that the sanitizer successfully stripped all the scripts
tags, self-submitting forms and event handlers:
Security Review done!</p>
<p><small>For convenience, I have uploaded my test results as a JSON file. It is
an <a href="http://pastebin.mozilla.org/2648340">array of objects</a> in the format <code>{"data": "...", "sanitized": "..."}</code>.</small></p>
</article>

<hr>

<section id="minicontact">
<em>
<!-- Please comment on <a href="https://social.security.plumbing/@freddy">Mastodon</a>. -->
If you find a mistake in this article, you can <a href="https://github.com/freddyb/homepage/edit/main/content/secreview-750436.md">submit a pull request on GitHub</a>.
</em>
</section>

<section id="article-list">
<h4>Recent posts</h4>
<ol>
  <li><a href="https://vaurenw.github.io/madweb-keynote-2025.html">With Carrots & Sticks - Can the browser handle web security?</a>
    <em>(Tue 08 April 2025)</em>
  </li>
  <li><a href="https://vaurenw.github.io/home-assistant-can-not-be-secured-for-internet-access.html">Home assistant can not be secured for internet access</a>
    <em>(Sun 15 December 2024)</em>
  </li>
  <li><a href="https://vaurenw.github.io/modern-solutions-xsleaks.html">Modern solutions against cross-site attacks</a>
    <em>(Tue 26 November 2024)</em>
  </li>
  <li><a href="https://vaurenw.github.io/prompt-injections-and-a-demo.html">Prompt Injections and a demo</a>
    <em>(Wed 18 September 2024)</em>
  </li>
  <li><a href="https://vaurenw.github.io/mozilla-monument.html">The Mozilla Monument in San Francisco</a>
    <em>(Fri 05 July 2024)</em>
  </li>
            
</ol>
</section>
</div>
</div>
</body>
</html>